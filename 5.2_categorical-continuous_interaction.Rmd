---
title: "Взаимодействие дискретных и непрерывных предикторов"
author: Марина Варфоломеева, Вадим Хайтов
output:
  ioslides_presentation:
    widescreen: true
    css: assets/my_styles.css
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE, cache = FALSE, purl = FALSE}
# output options
options(width = 70, scipen = 6, digits = 3)
library(knitr)
# chunk default options
opts_chunk$set(fig.align='center', tidy = FALSE, fig.width = 7, fig.height = 3, warning = FALSE)
```

## Мы рассмотрим

+ Линейные модели c непрерывными и дискретными предикторами
+ Взаимодействие дискретных и непрерывных предикторов

# ANCOVA на примере данных об активности пуромицина

## Пример: Пуромицин

Пуромицин - антибиотик пуронового ряда, ингибитор синтеза белков. 
Эти данные --- о том, как меняется активность фермента галактозил трансферазы под воздействием пуромицина (Treloar 1974). Измеряли скорость реакции в зависимости от концентрации субстрата на мембранах аппарата Гольджи из богатых мембранами фракций из печени крыс.

- `conc` --- концентрация пуромицина
- `rate` --- скорость химичемской реакции
- `state` --- индикатор того, обработаны ли клетки пуромицином

```{r}
data("Puromycin") # данные, встроенные в R
head(Puromycin)
```

## Знакомимся с данными

```{r}
sapply(Puromycin, class)
colSums(is.na(Puromycin))
nrow(Puromycin)
table(Puromycin$state)
```

## Задание

Постройте график зависимости скорости химической реакции от концентрации

## Решение


На самом деле, зависимость скорости химической реакции от концентрации нелинейна, но мы попробуем использовать трансформацию

```{r purl=FALSE, eval=FALSE}
library(ggplot2)
ggplot(Puromycin, aes(x = conc, y = rate, colour = state)) + 
  geom_point()
ggplot(Puromycin, aes(x = log(conc), y = rate, colour = state)) + 
  geom_point()
```

```{r gg-transformation, purl=FALSE, eval=TRUE, fig.width=10, echo=FALSE}
library(ggplot2)
library(gridExtra)
grid.arrange(
ggplot(Puromycin, aes(x = conc, y = rate, colour = state)) + geom_point(),
ggplot(Puromycin, aes(x = log(conc), y = rate, colour = state)) + geom_point(),
ncol = 2)
```

# Анализ ковариаций по данным о пуромицине

## Линейная модель

```{r}
Puromycin$lc <- log(Puromycin$conc)
M1 <- lm(rate ~ lc + state, data = Puromycin)
summary(M1)
```

## Проверяем выполнение условий применимости 

## Решение

```{r}
# Данные для графиков остатков
M1_diag <- fortify(M1)
```
### 1) График расстояния Кука

```{r}
ggplot(M1_diag, aes(x = 1:nrow(M1_diag), y = .cooksd)) +
  geom_bar(stat = "identity")
```

## Решение

### 2) График остатков от предсказанных значений
```{r}
gg_resid <- ggplot(data = M1_diag, aes(x = .fitted, y = .stdresid)) +
  geom_point() + geom_hline(yintercept = 0)
gg_resid
```

## Решение

### 3) Графики остатков от предикторов в модели и не в модели

```{r fig.width=10}
library(gridExtra)
grid.arrange(gg_resid + aes(x = lc), 
             gg_resid + aes(x = state), 
             nrow = 1)
```

## Решение

### 4) Квантильный график остатков
```{r fig.height=4}
qqPlot(M1)
```


# График предсказаний линейной модели

## Рисуем график предсказаний

Что не так с этим графиком? Это наша модель?

```{r M1-predictions}
ggplot(Puromycin, aes(x = lc, y = rate, colour = state)) + 
  geom_point() + 
  geom_smooth(method = "lm")
```

>- Здесь разный угол наклона. У нашей модели график должен быть другой, с одинаковым углом наклона

## Задание

Постройте график предсказаний модели по этим данным

### Данные для графика

```{r}
library(plyr)
NewData <- ddply(
  Puromycin, .variables = .(state), summarise, 
  lc = seq(min(lc), max(lc), length = 100))

# предсказанные значения
Predictions <- predict(M1, newdata = NewData, se.fit = TRUE)
NewData$fit <- Predictions$fit

# стандартные ошибки
NewData$SE <- Predictions$se.fit

# доверительный интервал
NewData$upr <- NewData$fit + 1.96 * NewData$SE
NewData$lwr <- NewData$fit - 1.96 * NewData$SE

# Обратная трансформация предиктора
NewData$conc <- exp(NewData$lc)
```

## Рисуем график предсказаний (Вторая попытка)

```{r gg-M1-predictions-backtrans, purl=FALSE}
ggplot(NewData, aes(x = conc, y = fit)) + 
  geom_ribbon(alpha = 0.2, aes(ymin = lwr, ymax = upr, group = state)) +
  geom_line(aes(colour = state)) +
  geom_point(data = Puromycin, aes(x = conc, y = rate, colour = state))
```

# Терминологический вопрос

## Классический анализ ковариаций ANCOVA 

$Response \sim Continuous + Categorical$

Требование гомогенности углов наклона (homogeneity of regression slopes) --- Нужно его протестировать, и если оно не выполняется, то это не ANCOVA

```{r gg-classic-ancova, echo=FALSE, purl=FALSE}
ggplot(NewData, aes(x = lc, y = fit)) + 
  geom_ribbon(alpha = 0.2, aes(ymin = lwr, ymax = upr, group = state)) +
  geom_line(aes(colour = state)) +
  geom_point(data = Puromycin, aes(x = lc, y = rate, colour = state))
```

##  Модель со взаимодействием дискретного и непрерывного предикторов

$Response \sim Continuous + Categorical + Continuous : Categorical$ (полная запись)

$Response \sim Continuous \times Categorical$ (сокращенная запись)

Возможен разный угол наклона прямых для разных групп

```{r gg-not-ancova, echo=FALSE, purl=FALSE}
ggplot(Puromycin, aes(x = lc, y = rate, colour = state)) + 
  geom_point() + 
  geom_smooth(method = "lm")
```

#  Модель со взаимодействием дискретного и непрерывного предикторов

##  Модель со взаимодействием дискретного и непрерывного предикторов {.smaller}

$Response \sim Continuous + Categorical + Continuous : Categorical$

```{r M2-interaction, R.options=list(width = 100)}
M2 <- lm(rate ~ lc + state + lc:state, data = Puromycin)
coef(M2)
```


##  Интерпретация коэффициентов <br /> в модели со взаимодействием дискретного и непрерывного предикторов {.smaller}

```{r M2-interaction, R.options=list(width = 100), purl=FALSE}
```

<br />

$$y_i = \beta_0 + \beta_1x_1 + \big(\beta_2x_2 + ... + \beta_l x_l\big) + \big(\beta_{l+1}x_{l+1} + ... + \beta_m x_m\big) + \epsilon_i$$

В случае, __если у дискретного фактора $k$ градаций__, уравнение полной модели будет включать несколько групп коэффициентов:

- $\beta_0$ --- значение свободного члена для базового уровня дискретного фактора
- $\beta_1$ --- коэффициент угла наклона для базового уровня дискретного фактора
- $\beta_2, ..., \beta_l$ --- коррекция свободного члена для других уровней (всего их $p = k - 1$)
- $\beta_{l+1}, ..., \beta_m$ --- коррекция коэффициентов угла наклона для других уровней (всего их $p = k - 1$)

## Задание {.smaller}

Глядя на коэффициенты линейной модели запишите уравнения:

- общее уравнение линейной модели
- уравнения для каждого из уровней дискретного фактора


```{r M2-coefficients, fig.height=2, R.options=list(width = 100)}
coef(M2)
ggplot(Puromycin, aes(x = lc, y = rate, colour = state)) + geom_point() + geom_smooth(method = "lm")
```

## Решение {.smaller}

```{r echo=FALSE, purl=FALSE}
lm_equation <- function(fit, strict = TRUE, rnd = 2){
#   extracting call formula 
  frml <- as.character(fit$call)[2]
#   extract signs
    sign <- ifelse(grepl("-", coef(fit)[-1]), " - ", " + ")
  # extract coefficients
  coeffs <- format(round(abs(coef(fit)), rnd), digits = 2, nsmall = rnd, trim = TRUE)
  if(strict == TRUE){
    i <- 1:(length(coeffs) - 1)
    vars <- c("Y", paste0(" X", i))
    
  } else {
# extract vector of variable names
  vars <- c(all.vars(formula(fit))[1], names(fit$coefficients)[-1])
# combine everything
  }
  start <- ifelse(coef(fit)[1] > 0, paste(vars[1], coeffs[1], sep = " = "), paste(vars[1], coeffs[1], sep = " = - "))
  end <- paste(sign, coeffs[-1], vars[-1], sep = "", collapse = "")
  return(paste0(start, end, sep = ""))
}
```

- общее уравнение линейной модели

$`r lm_equation(M2, strict = FALSE, rnd = 2)`$

- уравнения для каждого из уровней дискретного фактора

$rate_{treated} = 209.19 + 37.11 lc$

$rate_{untreated} = 164.58 + 26.98 lc$

```{r M2-coefficients, fig.height=2, R.options=list(width = 100), purl=FALSE}
```

## Тестируем гомогенность углов наклона

Это делается как обычно при выборе моделей: при помощи `anova()` или `drop1()`

```{r}
M1 <- lm(rate ~ lc + state, data = Puromycin)
M2 <- M2 <- lm(rate ~ lc + state + lc:state, data = Puromycin)

# anova(M1, M2, test="F")
drop1(M2, test = "F")
```

>- Если убрать взаимодействие, то модель становится значительно хуже. Поэтому взаимодействие сохраняем. Это не ANCOVA в традиционном понимании

## Представляем результаты в виде таблицы {.smaller}

### Вариант 1. Последовательное тестирование (SS type I)

Факторы тестируются в порядке включения в модель. Результат тестирования зависит от порядка включения.

```{r}
anova(M2)
anova(lm(rate ~ state + lc + state:lc, data = Puromycin))
```

## Представляем результаты в виде таблицы  {.smaller}

### Вариант 2. Иерархическое тестирование (SS type III)

Каждый из факторов по отношению к модели только без него, но со всеми остальными.
Нужно, если много факторов и выборки разного размера. Тогда результат не будет зависеть от порядка включения факторов в модель.

```{r}
# library(car)
Anova(M2, type = 3) 
```


# Модель со взаимодействием на примере данных о токсичности нитрофена

## Токсичность нитрофена

Нитрофен --- гербицид, тератоген, мутаген. Сейчас он не используется в США (первый пестицид, использование которого было запрещено из-за тератогенных эффектов), но все еще используется в России. Эти данные --- данные эксперимента по оценке токсичности нитрофена на дафниях _Ceriodaphnia dubia_ (Bailer, Oris 1994).

50 дафний случайно разделили на 5 групп, посадили в емкости с разной концентрацией нитрофена, оценили число яиц трех последовательных генераций.

- `conc` --- концентрация нитрофена
- `total` --- суммарный размер потомства
- `brood` --- номер выводка
- `N` --- размер потомства в выводке

```{r}
library(readxl)
nit <- read_excel("data/nitrofen.xlsx", sheet = 1)
head(nit)
```

## Задание

- Исследуйте данные о токсичноси нитрофена
- Чтобы выяснить, как численность потомства дафний зависит от концентрации нитрофена в каждом из трех выводков, подберите модель со взаимодействием дискретного и непрерывного предикторов
- Проверьте условия применимости этой модели
- Упростите модель, если это возможно
- Напишите общее уравнение и отдельные уравнения модели для трех выводков
- Постройте график предсказаний модели

## Решение

```{r}
str(nit)
colSums(is.na(nit))
table(nit$conc, nit$brood)
```

## Решение

```{r fig.show='hold', fig.height=2.5}
ggplot(nit, aes(x = total, y = 1:nrow(nit))) + geom_point()
ggplot(nit, aes(x = N, y = 1:nrow(nit))) + geom_point()
```

## Решение

### Проверка на колинеарность

```{r}
N1 <- lm(N ~ conc + brood, data = nit)
vif(N1)
```

>- Колинеарности нет

## Решение

### Проверка на гомогенность углов наклона

Подберем полную модель. Попробуем для начала не учитывать общую плодовитость `total` (хоть это и не правильно)

```{r}
N2 <- lm(N ~ conc * brood + total, data = nit)
drop1(N2, test = "F")
```

>- От исключения взаимодействия модель становится значительно хуже. Оставляем. Это не ANCOVA

## Решение

```{r}
# Данные для графиков остатков
N2_diag <- fortify(N2)
```
### 1) График расстояния Кука

```{r}
ggplot(N2_diag, aes(x = 1:nrow(N2_diag), y = .cooksd)) +
  geom_bar(stat = "identity")
```

## Решение

### 2) График остатков от предсказанных значений
```{r}
gg_resid <- ggplot(data = N2_diag, aes(x = .fitted, y = .stdresid)) +
  geom_point() + geom_hline(yintercept = 0)
gg_resid
```

Откуда эти полосочки?

>- Это счетные данные, поэтому полоски --- это N = 0, 1, 2, и т.п.

## Решение

### 3) Графики остатков от предикторов в модели и не в модели

```{r fig.width=10}
library(gridExtra)
grid.arrange(gg_resid + aes(x = conc), 
             gg_resid + aes(x = brood), 
             gg_resid + aes(x = total),
             nrow = 1)
```

## Решение

### 4) Квантильный график остатков
```{r fig.height=4}
qqPlot(N2)
```

## Проверяем значимость коэффициентов {.smaller}

```{r}
summary(N2)
```

## Таблица дисперсионного анализа

```{r}
anova(N2)
```

## Записываем уравнение модели

```{r}
coef(N2)
```

Общее уравнение: 

`r lm_equation(N2, strict = FALSE)`

- Для выводка 1: $N = -6.72 + 0.03conc + 0.33total$
- Для выводка 2: $N = 2.1 - 0.01conc + 0.33total$
- Для выводка 3: $N = 4.61 - 0.02conc + 0.33total$

## Задание

Постройте график предсказаний модели

<!-- ## Данные для графика -->

<!-- ```{r} -->
<!-- library(plyr) -->
<!-- NewData <- ddply( -->
<!--   nit, .variables = .(brood), summarise,  -->
<!--   total = seq(min(total), max(total), length = 100)) -->

<!-- # предсказанные значения -->
<!-- Predictions <- predict(N2, newdata = NewData, se.fit = TRUE) -->
<!-- NewData$fit <- Predictions$fit -->

<!-- # стандартные ошибки -->
<!-- NewData$SE <- Predictions$se.fit -->

<!-- # доверительный интервал -->
<!-- NewData$upr <- NewData$fit + 1.96 * NewData$SE -->
<!-- NewData$lwr <- NewData$fit - 1.96 * NewData$SE -->
<!-- ``` -->

<!-- ## Рисуем график предсказаний (Вторая попытка) -->

<!-- ```{r gg-M1-predictions-backtrans, purl=FALSE} -->
<!-- ggplot(NewData, aes(x = conc, y = fit)) +  -->
<!--   # geom_ribbon(alpha = 0.2, aes(ymin = lwr, ymax = upr, group = brood)) + -->
<!--   # geom_line(aes(colour = brood)) + -->
<!--   geom_point(data = nit, aes(x = conc, y = N, colour = brood)) -->
<!-- ``` -->



## Take home messages

- У дискретных и непрерывных факторов могут быть взаимодействия, поэтому анализ нужно начинать с более полной модели (чтобы можно было  протестировать и исключить недостоверные взаимодействия)

## Что почитать

+ <span style="color:red">Must read paper!</span> Zuur, A.F. and Ieno, E.N., 2016. A protocol for conducting and presenting results of regression‐type analyses. Methods in Ecology and Evolution, 7(6), pp.636-645.

+ Кабаков Р.И. R в действии. Анализ и визуализация данных на языке R. М.: ДМК Пресс, 2014
+ Zuur, A., Ieno, E.N. and Smith, G.M., 2007. Analyzing ecological data. Springer Science & Business Media.
+ Quinn G.P., Keough M.J. 2002. Experimental design and data analysis for biologists
+ Logan M. 2010. Biostatistical Design and Analysis Using R. A Practical Guide

