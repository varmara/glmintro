---
title: "Множественная линейная регрессия"
subtitle: 
author: "Вадим Хайтов"
output:
  ioslides_presentation:
    css: assets/my_styles.css
    logo: 
    widescreen: yes
---

```{r setup, include = FALSE, cache = FALSE, purl = FALSE}
# output options
options(width = 70, scipen = 6, digits = 3)
library(knitr)
# chunk default options
opts_chunk$set(fig.align='center', tidy = FALSE, fig.width = 7, fig.height = 3, warning = FALSE)
```


## Множественная регрессия

+ Техника подгонки множественных регрессионных моделей
+ Проверка условий применимости множественных регрессионных моделей 

### Вы сможете

+ Подобрать множественную линейную модель
+ Протестировать ее статистическую значимость и валидность

## Пример: связь между размером злокачественной опухоли простаты и прочими клиническими параметрами {.columns-2}
Вопрос: можно ли судить о величине опухоли базируясь на знаниях клинических параметров. 

Исследовано 97 пациентов, перенесших простатотомию. 

Источник: Stamey, T.A., Kabalin, J.N., McNeal, J.E., Johnstone, I.M., Freiha, F., Redwine, E.A. and Yang, N. (1989) Prostate specific antigen in the diagnosis and treatment of adenocarcinoma of the prostate: II. radical prostatectomy treated patients, Journal of Urology 141(5), 1076–1083.

**Зависимая перменная**

- lcavol - log(cancer volume)

**Предикторы**

lweight - log(prostate weight)

age - Возраст

lbph - log(benign prostatic hyperplasia amount)

svi - seminal vesicle invasion

lcp - log(capsular penetration)

gleason - Gleason score

pgg45 - percentage Gleason scores 4 or 5

lpsa - log(prostate specific antigen)




## Читаем данные

```{r}
library(readxl)
prost <- read_excel("data/Prostate.xlsx")
```

## Проверяем, все ли правильно открылось

```{r}
str(prost)
```

## Есть ли пропущенные значения?

```{r}
sapply(prost, function(x)sum(is.na(x)))
```


## Можно ли ответить на вопрос таким методом? {.smaller}

```{r}
round(cor(prost), 2)
```

##Так нельзя!

- Обычная корреляция не учитывает, что взаимосвязь между переменными может находиться под контролем других переменых и их взаимодействий.
- Множественные тесты. При тестировании значимости множества коэффициентов корреляции нужно вводить поправку для уровня значимости. Лучше было бы учесть все в одном анализе.

## Нам предстоит построить множественную регрессионную модель

$$y_i = \beta_0 + \beta_1x_{i1} + \beta_2x_{i2} + \beta_3x_{i3} + ... + \beta_px_{ip} + \varepsilon_i$$

- $y_i$ - значение зависимой переменной для $i$-того наблюдения
- $\beta_0$ - свободный член (intercept). Значение $Y$ при $X_1=X_2=X_3=....=X_p=0$  
- $\beta_1$ - частный угловой коэффициент для зависимости $Y$ от $X_1$. Показывает насколько единиц изменяется $Y$ при изменении $X_1$ на одну единицу и при условии, что все остальные предикторы не изменяются.  
$\beta_2$, $\beta_3$, ...., $\beta_p$ - аналогично   
- $\varepsilon_i$ - варьирование $Y$, не объясняемое данной моделью


## Геометрическая интерпретация множественной линейной модели 

### Для случая с одним предиктором $y_i = \beta_0 + \beta_1x_i + \varepsilon_i$ --- линия регрессии

```{r, echo=FALSE, purl=FALSE}
library(ggplot2)
theme_set(theme_bw())
x <- runif(100, 0, 10)
y <- 10*x + 10 + rnorm(100, 0, 50)
qplot (x=x, y=y) + geom_smooth(method = "lm")
```

## Геометрическая интерпретация множественной линейной модели

### Для случая с двумя предикторами $y_i = \beta_0 + \beta_1x_{i1} + \beta_2x_{i2} + \varepsilon_i$ --- плоскость в трехмерном пространстве

```{r, echo=FALSE, fig.height=6, fig.width=6, fig.height=5, purl=FALSE}
library(plot3D)
with (mtcars, {
  
  # linear regression
   fit <- lm(mpg ~ wt + disp)

  # predict values on regular xy grid
   wt.pred <- seq(1.5, 5.5, length.out = 30)
   disp.pred <- seq(71, 472, length.out = 30)
   xy <- expand.grid(wt = wt.pred, 
                     disp = disp.pred)

   mpg.pred <- matrix (nrow = 30, ncol = 30, 
      data = predict(fit, newdata = data.frame(xy), 
      interval = "prediction"))

# fitted points for droplines to surface
   fitpoints <- predict(fit) 

   scatter3D(z = mpg, x = wt, y = disp, pch = 18, cex = 2, theta = 20, phi = 20, ticktype = "detailed", xlab = "First predictor X1", ylab = "Second predictor X2", zlab = "Response variable",  surf = list(x = wt.pred, y = disp.pred, z = mpg.pred,  facets = NA, fit = fitpoints), main = "")
  
 })

```

## Геометрическая интерпретация множественной линейной модели

### Для случая с большим количеством предикторов 

$$y_i = \beta_0 + \beta_1x_{i1} + \beta_2x_{i2} + \beta_3x_{i3} + ... + \beta_px_{ip} + \varepsilon_i$$

Плоскость в n-мерном пространстве, оси которого образованы значениями предикторов


## Исследование данных (Data Exploration)
Задание: Постройте dotplot для всех переменных, оцените присутствие отскакивающих значений

##Решение 


```{r, echo=FALSE, fig.height=5}
library(gridExtra)
Pl1 <- ggplot(prost, aes(x = 1:nrow(prost), y = lcavol)) + geom_point()
Pl2 <- ggplot(prost, aes(x = 1:nrow(prost), y = lweight)) + geom_point()
Pl3 <- ggplot(prost, aes(x = 1:nrow(prost), y = age)) + geom_point()
Pl4 <- ggplot(prost, aes(x = 1:nrow(prost), y = lbph)) + geom_point()
Pl5 <- ggplot(prost, aes(x = 1:nrow(prost), y = svi)) + geom_point()
Pl6 <- ggplot(prost, aes(x = 1:nrow(prost), y = lcp)) + geom_point()
Pl7 <- ggplot(prost, aes(x = 1:nrow(prost), y =  gleason)) + geom_point()
Pl8 <- ggplot(prost, aes(x = 1:nrow(prost), y =  pgg45)) + geom_point()
Pl9 <- ggplot(prost, aes(x = 1:nrow(prost), y =  lpsa)) + geom_point()

grid.arrange(Pl1, Pl2, Pl3, Pl4, Pl5, Pl6, Pl7, Pl8, Pl9, ncol =3, nrow = 3)

```




## Явные проблемы --- есть сильные корреляции между некоторым предикторами

```{r fig.height=7, fig.height=7, fig.width=8, echo=FALSE}
scatterplotMatrix(prost[ , -1])
```

## Задание

- Напишите код, который позволит рассчитать парамтеры линейной модели, описывющей зависимиоть lcavol от всех остальных величин (lweight, age, lbph, svi, lcp, gleason, pgg45, lpsa)



## Решение

```{r}
mod1 <- lm(lcavol ~ lweight + age + lbph + svi + lcp + gleason + pgg45 + lpsa, data = prost)
mod1 <- lm(lcavol ~  . , data = prost) # то же самое

summary(mod1)
```

# Проверка валидности модели

## Вспомним условия применимости линейных моделей

- Линейная связь между зависимой перменной ($Y$) и предикторами ($X$)
- Независимость значений $Y$ друг от друга
- Нормальное распределение $Y$ для каждого уровня значений $X$
- Гомогенность дисерсий $Y$ для каждого уровня значений $X$
- Отсутствие коллинеарности предикторов (для можественной регрессии)

## Задание

- Проверьте условия применимости модели


## Решение средствами базовой графики

```{r purl=TRUE}
op <- par(mfrow = c(1, 3))
plot(mod1, which = 4)
residualPlot(mod1)
qqPlot(mod1)
par(op)
```


- Выбросов нет
- Гетерогенность дисперсии не выявляется
- Отклонения от нормального распределения остатков не выявляются
- Есть намек на нелинейность связей

## Решение в `ggplot2`

```{r, purl=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
prost_diag <- fortify(mod1)
# квантильный график
mean_val <- mean(prost_diag$.stdresid)
sd_val <- sd(prost_diag$.stdresid)
gg_qq <- ggplot(prost_diag, aes(sample = .stdresid)) + geom_point(stat = "qq") + geom_abline(intercept = mean_val, slope = sd_val)
# остатки и расстояние Кука
gg_res <- ggplot(data = prost_diag, aes(x = .fitted, y = .stdresid, size = .cooksd)) + geom_point() + geom_hline(aes(yintercept = 0)) + geom_smooth(se = F)
# вместе
library(gridExtra)
grid.arrange(gg_qq, gg_res, nrow = 1, widths = c(0.45, 0.55))
```


# Мультиколинеарность

## Мультиколинеарность

Мультиколинеарность ---  наличие линейной зависимости между независимыми переменными (факторами) регрессионной модели.

При наличии мультиколинеарности оценки параметров получаются неточными, а значит сложно будет дать интерпретацию влияния предикторов на отклик. 

Косвенные признаки мультиколинеарности:

- Большие ошибки оценок параметров             
- Большинство параметров модели недостоверно отличаются от нуля, но F критерий говорит, что вся модель значима

### Проверка на мультиколинеарность

- Фактор инфляции дисперсии (Variance inflation factor, VIF)

## Как рассчитывается VIF

Мы должны оценить какую долю изменчивости конкретного предиктора могут объяснить другие предикторы (т.е. насколько предикторы независимы)

Для каждого предиктора:

1. Строим регрессионную модель данного предиктора от всех остальных
$$x_1 = c_0 + c_2x_2 +c_2x_3 + .... + c_px_p$$
2. Находим $R^2$ модели
3. Вычисляем фактор инфляции дисперсии
$$VIF = \frac{1}{1-R^2}$$

## Что делать, если мультиколинеарность выявлена?

- Можно последовательно удалить из модели избыточные предикторы с VIF > 3 (иногда VIF > 2)
    1. подбираем модель
    2. считаем VIF
    3. удаляем предиктор с самым большим VIF
    4. повторяем 1-3

- Можно заменить исходные предикторы новыми независимыми друго от друга переменными, полученными с помощью метода главных компонент

## Проверяем отсутствие мультиколинеарности

Функция `vif()` из пакета `car`
```{r}
vif(mod1)
```


В нашей модели явной мультколинеарности нет

Однако, возможно, что  `pgg45` - избыточный предиктор

## Удалим из модели избыточный предиктор

```{r}
mod2 <- update(mod1, ~ . -pgg45)
vif(mod2)
```

Теперь мультиколинеарности нет

## В этой модели осталось много незначимых предикторов {.smaller}

```{r}
summary(mod2)
```

### Что дальше?

Два варианта действий:

- Оставить все как есть. Если значение коэффициента при предикторе не  отличается значимо от нуля, значит, этот предиктор не влияет на объем опухоли
- Провести пошаговый подбор оптимальной модели (об этом позднее)

Пока оставим все как есть и попытаемся выяснить, какие предикторы влияют сильнее всего

## Какой из предиктов оказывает наиболее сильное влияние?

Для ответа на этот вопрос надо "уравнять" шкалы, всех предикторов, то есть стандартизовать их. 

Коэффициенты при стандартизованных предикторах покажут, насколько сильно меняется отклик при изменении предиктора на одно стандартное отклонение.

Для стандартизации используем функцию `scale()`

```{r, tidy=TRUE}
mod2_scaled <- lm(lcavol ~ scale(lweight) + scale(age) + scale(lbph) + scale(svi) + scale(lcp) + scale(gleason) + scale(pgg45) + scale(lpsa), data = prost)
```

## Какой из предиктов оказывает наиболее сильное влияние? {.smaller}

```{r}
summary(mod2_scaled)
```

## Вопрос
Какая доля суммарной дисперсии зависимой переменной описывается данной моделью

## Еще раз про Adjusted R-squared - скорректированный коэффициет детерминации

Применяется если необходимо сравнить две модели с разным количеством параметров  

$$ R^2_{adj} = 1- (1-R^2)\frac{n-1}{n-k}$$

$k$ - количество параметров в модели   

Вводится штраф за каждый новый параметр



## Какой из предиктов оказывает наиболее сильное влияние?

- Сильнее всего c объемом опухоли связан, lpsa (концетрация специфического антигена) и lcp (capsular penetration).
- При изменении логарифма концентрации антигена на 1 стандартное отклонение, логарифм объема опухоли изменяется на `r round(coef(mod2_scaled)[9], 2)`
- При изменении логарифма capsular penetration на 1 стандартное отклонение, логарифм объема опухоли изменяется на `r round(coef(mod2_scaled)[6], 2)`

## Include or Don't include? That is the question...

В рассмотренной модели мы не пытались выяснить есть ли взаимодействия предикторов. То есть мы изначально заложили в модель идею, что влияние на зависимую переменную каждого из предикторов не зависит от других предикторов.


## Include or Don't include? That is the question...


Вопрос о включении в модель взаимоодействия предикторов совсем непростой

Существует несколько подходов:

1. Не включать взаимодействия в модель. Но если при валидации модели в остатках появляется явный паттерн, то это может быть следствием наличия взаимодействия предикторов   
2. Основываясь на априорных знаниях свойств объектов включить только те взаимоотношения, которые имеют биологический смысл, либо взаимодействия с наиболее важными переменными (теми, ради которых была затеяна работа)   
3. Включать в модель все взаимодействия, потом пошагово выбросить недостоверные (Model selection - об этом позднее)



## Include or Don't include? That is the question...

Включать в анализ и обсуждать все взаимодействия "дорого" (неудобно):

- Взаимодействия высоких порядков сложно интерпретировать
- Каждое взаимодействие --- это коэффициент в модели, или несколько, если это взаимодействие с дискретной переменной. Чтобы подобрать модель нужно много данных --- по 20-40 наблюдений в расчете на каждый коэффициент.



## Summary

- При построении множественной регрессии важно, помимо других условий, проверить модель на наличие мультиколинеарности
- Если модель построена на основе стандартизированных значений предикторов, то можно сравнивать влияние этих предикторов
- В модель можно (а иногда и нужно) включать взаимодействия предикторов

## Что почитать

+ Кабаков Р.И. R в действии. Анализ и визуализация данных на языке R. М.: ДМК Пресс, 2014.
+ Quinn G.P., Keough M.J. (2002) Experimental design and data analysis for biologists, pp. 92-98, 111-130
+ Diez D. M., Barr C. D., Cetinkaya-Rundel M. (2014) Open Intro to Statistics., pp. 354-367.
+ Logan M. (2010) Biostatistical Design and Analysis Using R. A Practical Guide, pp. 170-173, 208-211
+ Zuur, A.F. et al. 2009. Mixed effects models and extensions in ecology with R. - Statistics for biology and health. Springer, New York, NY. pp. 538-552.



